#!/bin/bash

# Git pre-commit hook to run unit tests
# This hook runs before each commit to ensure tests pass

echo "Running unit tests before commit..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Run backend tests
echo "ğŸ Running backend tests..."
cd backend

# Run unit tests with pytest
# -q for quiet mode (less verbose output)
# --tb=short for shorter traceback on failures
# -x to stop on first failure
pytest unit_tests/ -q --tb=short -x

# Capture the exit code
BACKEND_EXIT_CODE=$?

# Return to the root directory
cd ..

# If backend tests failed, prevent the commit
if [ $BACKEND_EXIT_CODE -ne 0 ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ Backend tests failed! Commit aborted."
    echo "Fix the failing tests before committing."
    exit 1
fi

echo "âœ… Backend tests passed!"
echo ""

# Run frontend tests
echo "âš›ï¸  Running frontend tests..."
cd frontend

# Check if node_modules exists (frontend dependencies installed)
if [ ! -d "node_modules" ]; then
    echo "âš ï¸  Frontend dependencies not installed. Skipping frontend tests."
    echo "Run 'cd frontend && npm install' to enable frontend testing."
else
    # Run Jest with coverage
    npm run test:coverage --silent

    # Capture the exit code
    FRONTEND_EXIT_CODE=$?

    # Return to the root directory
    cd ..

    # If frontend tests failed, prevent the commit
    if [ $FRONTEND_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Frontend tests failed! Commit aborted."
        echo "Fix the failing tests or coverage thresholds before committing."
        exit 1
    fi

    echo "âœ… Frontend tests passed!"
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All tests passed!"
exit 0
