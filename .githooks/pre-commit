#!/bin/bash

# Git pre-commit hook to run linting, type checking, and tests
# This hook runs before each commit to ensure code quality

echo "Running pre-commit checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Run backend checks
echo "ğŸ Running backend checks..."
cd backend

# Activate virtual environment if it exists
if [ -d ".venv" ]; then
    source .venv/bin/activate
elif [ -d "venv" ]; then
    source venv/bin/activate
else
    echo "âš ï¸  No virtual environment found (.venv or venv)"
    echo "Tools will use system-level installations"
fi

# Check if ruff is installed
if ! command -v ruff &> /dev/null; then
    echo "âš ï¸  Ruff not installed. Run 'pip install -r requirements-dev.txt'"
    echo "Skipping linting checks..."
else
    # Run Ruff linting
    echo "  â†’ Checking code with Ruff..."
    ruff check .
    RUFF_EXIT_CODE=$?
    
    if [ $RUFF_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Ruff linting failed! Commit aborted."
        echo "Run 'make format' or 'ruff check --fix .' to fix issues."
        cd ..
        exit 1
    fi
    echo "  âœ“ Ruff checks passed"
fi

# Check if mypy is installed
if ! command -v mypy &> /dev/null; then
    echo "âš ï¸  mypy not installed. Run 'pip install -r requirements-dev.txt'"
    echo "Skipping type checking..."
else
    # Run mypy type checking
    echo "  â†’ Type checking with mypy..."
    mypy app/
    MYPY_EXIT_CODE=$?
    
    if [ $MYPY_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ mypy type checking failed! Commit aborted."
        echo "Fix type errors or add type ignores where appropriate."
        cd ..
        exit 1
    fi
    echo "  âœ“ Type checking passed"
fi

# Run unit tests with pytest and coverage checking
echo "  â†’ Running unit tests with coverage..."
pytest unit_tests/ -q --tb=short -x --cov=app --cov-report=term-missing --cov-fail-under=95

# Capture the exit code
BACKEND_EXIT_CODE=$?

# Return to the root directory
cd ..

# If backend tests failed, prevent the commit
if [ $BACKEND_EXIT_CODE -ne 0 ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ Backend tests or coverage check failed! Commit aborted."
    echo "Fix the failing tests or improve coverage to meet 95% threshold before committing."
    exit 1
fi

echo "âœ… Backend tests passed!"
echo ""

# Run frontend checks
echo "âš›ï¸  Running frontend checks..."
cd frontend

# Check if node_modules exists (frontend dependencies installed)
if [ ! -d "node_modules" ]; then
    echo "âš ï¸  Frontend dependencies not installed. Skipping frontend checks."
    echo "Run 'cd frontend && npm install' to enable frontend testing."
else
    # Run Prettier format check
    echo "  â†’ Checking code formatting with Prettier..."
    npm run format:check --silent
    PRETTIER_EXIT_CODE=$?
    
    if [ $PRETTIER_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Code formatting check failed! Commit aborted."
        echo "Run 'cd frontend && npm run format' to fix formatting issues."
        cd ..
        exit 1
    fi
    echo "  âœ“ Code formatting passed"

    # Run ESLint
    echo "  â†’ Linting with ESLint..."
    npm run lint --silent
    ESLINT_EXIT_CODE=$?
    
    if [ $ESLINT_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ ESLint check failed! Commit aborted."
        echo "Run 'cd frontend && npm run lint:fix' to fix linting issues."
        cd ..
        exit 1
    fi
    echo "  âœ“ ESLint passed"

    # Run Jest with coverage
    echo "  â†’ Running unit tests..."
    npm run test:coverage --silent

    # Capture the exit code
    FRONTEND_EXIT_CODE=$?

    # Return to the root directory
    cd ..

    # If frontend tests failed, prevent the commit
    if [ $FRONTEND_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Frontend tests failed! Commit aborted."
        echo "Fix the failing tests or coverage thresholds before committing."
        exit 1
    fi

    echo "âœ… Frontend checks passed!"
fi

echo ""

# Run E2E checks
echo "ğŸ­ Running E2E checks..."
cd e2e

# Check if node_modules exists (E2E dependencies installed)
if [ ! -d "node_modules" ]; then
    echo "âš ï¸  E2E dependencies not installed. Skipping E2E checks."
    echo "Run 'cd e2e && npm install' to enable E2E linting and formatting."
else
    # Run Prettier format check
    echo "  â†’ Checking code formatting with Prettier..."
    npm run format:check --silent
    E2E_PRETTIER_EXIT_CODE=$?
    
    if [ $E2E_PRETTIER_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ E2E code formatting check failed! Commit aborted."
        echo "Run 'cd e2e && npm run format' to fix formatting issues."
        cd ..
        exit 1
    fi
    echo "  âœ“ Code formatting passed"

    # Run ESLint
    echo "  â†’ Linting with ESLint..."
    npm run lint --silent
    E2E_ESLINT_EXIT_CODE=$?
    
    if [ $E2E_ESLINT_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ E2E ESLint check failed! Commit aborted."
        echo "Run 'cd e2e && npm run lint:fix' to fix linting issues."
        cd ..
        exit 1
    fi
    echo "  âœ“ ESLint passed"

    # Run TypeScript type checking
    echo "  â†’ Type checking with TypeScript..."
    npm run type-check --silent
    E2E_TYPECHECK_EXIT_CODE=$?
    
    if [ $E2E_TYPECHECK_EXIT_CODE -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ E2E type checking failed! Commit aborted."
        echo "Fix type errors before committing."
        cd ..
        exit 1
    fi
    echo "  âœ“ Type checking passed"

    echo "âœ… E2E checks passed!"
    
    # Return to the root directory
    cd ..
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… All tests passed!"
exit 0
