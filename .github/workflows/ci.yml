name: CI - All Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Run backend tests first (unit + integration)
  backend-tests:
    name: Backend Tests
    uses: ./.github/workflows/backend-tests.yml

  # Run frontend tests in parallel with backend
  frontend-tests:
    name: Frontend Tests
    uses: ./.github/workflows/frontend-tests.yml

  # Run E2E tests only after unit tests pass
  e2e-tests:
    name: E2E Tests
    needs: [backend-tests, frontend-tests]
    uses: ./.github/workflows/e2e-tests.yml

  # Summary job to report overall status
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, e2e-tests]
    if: always()
    
    steps:
      - name: Check all test results
        run: |
          echo "## CI Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Backend tests
          if [[ "${{ needs.backend-tests.result }}" == "success" ]]; then
            echo "âœ… **Backend Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Backend Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Frontend tests
          if [[ "${{ needs.frontend-tests.result }}" == "success" ]]; then
            echo "âœ… **Frontend Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Frontend Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # E2E tests
          if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "âœ… **E2E Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **E2E Tests**: Failed or Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall result
          if [[ "${{ needs.backend-tests.result }}" == "success" ]] && \
             [[ "${{ needs.frontend-tests.result }}" == "success" ]] && \
             [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **Overall**: All tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âš ï¸ **Overall**: Some tests failed. Review artifacts for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
